<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bus Monitoring - Daily Digest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .loading {
            text-align: center;
            padding: 20px;
            color: #6a0dad;
        }
        .error {
            text-align: center;
            padding: 20px;
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
        }
        .bus-container {
            margin-bottom: 30px;
            border: 3px solid #6a0dad;
            border-radius: 10px;
            padding: 15px;
        }
        .system-status {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .status-box {
            text-align: center;
            padding: 10px;
            border: 2px solid #6a0dad;
            border-radius: 8px;
            background-color: #d4edda;
            color: #155724;
            margin: 5px;
            flex: 1;
            min-width: 120px;
            max-width: 180px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        th, td {
            border: 2px solid #6a0dad;
            padding: 12px;
            text-align: center;
        }
        .more-trips-row {
            background-color: #f3e8ff;
        }
    </style>
</head>
<body style="font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 15px;">

<!-- HEADER SECTION WITH LOGO -->
<div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px;">
    <h1 style="text-align: center; color: #6a0dad; margin: 8px 0;">🚌 Daily School Bus Report - Priyadarshani International School</h1>
    <p id="report-date" style="text-align: center; font-weight: bold; margin: 6px 0;">Date: Loading...</p>
</div>

<!-- Loading/Error Messages -->
<div id="loading" class="loading">
    <i class="fas fa-spinner fa-spin"></i> Loading bus data...
</div>

<div id="error" class="error" style="display: none;">
    Error loading bus data. Please try again later.
</div>

<!-- Bus Reports Container -->
<div id="bus-reports-container"></div>

<script>
// Configuration
const API_CONFIG = {
    baseUrl: 'https://schoolbusapi.com/school/all/bus_summary/',
    schoolId: '6',
    date: '2025-08-14' // You can make this dynamic based on today's date
};

// Utility functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}

function formatTime(timeString) {
    if (!timeString) return '-';
    const date = new Date(timeString);
    return date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
}

function parseDuration(durationString) {
    if (!durationString) return '-';
    return durationString.replace(/(\d+)h (\d+)m (\d+)s/, '$1 Hr $2 min');
}

// Create system status HTML
function createSystemStatus() {
    return `
        <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">🖥 System Status</h3>
        <div class="system-status">
            <div class="status-box">
                <p style="text-align: center; font-weight: bold; margin: 5px 0;">📹 CCTV</p>
                <strong>OPERATIONAL</strong>
            </div>
            <div class="status-box">
                <p style="text-align: center; font-weight: bold; margin: 5px 0;">🛰 GPS</p>
                <strong>OPERATIONAL</strong>
            </div>
            <div class="status-box">
                <p style="text-align: center; font-weight: bold; margin: 5px 0;">🖥 SERVER</p>
                <strong>OPERATIONAL</strong>
            </div>
        </div>
    `;
}

// Create performance summary HTML
function createPerformanceSummary(activitySummary) {
    return `
        <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">📊 Performance & Activity Summary</h3>
        <table>
            <tr>
                <td>📏 Total Distance<br><strong>${activitySummary.total_distance}</strong></td>
                <td>⏱ Running Time<br><strong>${parseDuration(activitySummary.running_time)}</strong></td>
                <td>🚀 Max Speed<br><strong>${activitySummary.max_speed}</strong></td>
                <td>🎯 Average Speed<br><strong>${activitySummary.average_speed}</strong></td>
            </tr>
        </table>
    `;
}

// Create attendance report HTML
function createAttendanceReport(attendanceData) {
    let tableRows = attendanceData.map(route => `
        <tr>
            <td>${route.route_name}</td>
            <td>${route.total_students}</td>
            <td>${route.present}</td>
            <td>${route.absent}</td>
            <td>${route.not_marked}</td>
        </tr>
    `).join('');

    return `
        <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">🎓Route Wise Student Attendance Report</h3>
        <table>
            <tr>
                <th>🚍 Route Name</th>
                <th>👩‍🎓 Total Students</th>
                <th>✅ Present</th>
                <th>❌ Absent</th>
                <th>⚠ Not Marked</th>
            </tr>
            ${tableRows}
        </table>
    `;
}

// Create trip summary HTML
function createTripSummary(tripData) {
    let tripRows = '';
    let tripNumber = 1;
    
    tripData.forEach(tripObj => {
        const tripKey = Object.keys(tripObj)[0];
        const trip = tripObj[tripKey];
        
        tripRows += `
            <tr>
                <td>${tripNumber.toString().padStart(2, '0')}</td>
                <td>${formatTime(trip.start_time)}</td>
                <td>${formatTime(trip.end_time)}</td>
                <td>${trip.trip_distance}</td>
                <td>${parseDuration(trip.duration)}</td>
                <td>${trip.max_speed}</td>
                <td>${trip.average_speed}</td>
            </tr>
        `;
        tripNumber++;
    });

    // // Add "more trips" row if there are more than 3 trips
    // if (tripData.length > 3) {
    //     tripRows += `
    //         <tr class="more-trips-row">
    //             <td colspan="7" style="background-color: #f3e8ff;">
    //                 📊 Showing ${Math.min(3, tripData.length)} of ${tripData.length} trips. 
    //                 <a href="#" style="color: #6a0dad; text-decoration: underline; font-weight: bold;">
    //                     View all trips on dashboard
    //                 </a>
    //             </td>
    //         </tr>
    //     `;
    // }

    return `
        <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">🚌 Trip Summary</h3>
        <table>
            <tr>
                <th>🚍 Trip No</th>
                <th>⏰ Start Time</th>
                <th>🔚 End Time</th>
                <th>⏳ Trip Distance</th>
                <th>⏲ Duration</th>
                <th>🚀 Max Speed</th>
                <th>🎯 Avg Speed</th>
            </tr>
            ${tripRows}
        </table>
    `;
}

// Create individual bus report HTML
function createBusReport(busName, busData) {
    const busNumber = busName.split(' - ')[2]; // Extract bus number like "MH 15 EF 0978"
    
    return `
        <div class="bus-container">
            <h2 style="text-align: center; color: #6a0dad; margin: 10px 0;">🚍 ${busName}</h2>
            
            ${createSystemStatus()}
            ${createPerformanceSummary(busData.activity_summary)}
            ${createAttendanceReport(busData.route_wise_attendance_report)}
            ${createTripSummary(busData.trip_summary)}
            
            <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">🚌 Speed Analysis</h3>
            <img src="https://i.postimg.cc/XJDrQ1hT/B1-MH15-AT1254-2025-08-08.png" 
                 alt="Speed Analysis Chart" 
                 style="max-width: 100%; height: auto;">
        </div>
    `;
}

// Fetch and render bus data
async function fetchAndRenderBusData() {
    const loadingElement = document.getElementById('loading');
    const errorElement = document.getElementById('error');
    const containerElement = document.getElementById('bus-reports-container');
    const dateElement = document.getElementById('report-date');

    try {
        // Show loading
        loadingElement.style.display = 'block';
        errorElement.style.display = 'none';

        // Construct API URL
        const apiUrl = `${API_CONFIG.baseUrl}?school_id=${API_CONFIG.schoolId}&date=${API_CONFIG.date}`;
        
        // For demonstration, using the provided sample data
        // In real implementation, uncomment the fetch call below:
        // 
        const response = await fetch(apiUrl);
        // 
        const data = await response.json();
        
        // Sample data for demonstration
        

        // Hide loading
        loadingElement.style.display = 'none';

        // Update date
        dateElement.textContent = `Date: ${formatDate(API_CONFIG.date)}`;

        // Generate HTML for each bus
        let busReportsHtml = '';
        Object.entries(data).forEach(([busName, busData]) => {
            busReportsHtml += createBusReport(busName, busData);
        });

        // Update container
        containerElement.innerHTML = busReportsHtml;

    } catch (error) {
        console.error('Error fetching bus data:', error);
        loadingElement.style.display = 'none';
        errorElement.style.display = 'block';
        errorElement.textContent = `Error loading bus data: ${error.message}`;
    }
}

// Function to refresh data
function refreshData() {
    fetchAndRenderBusData();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', fetchAndRenderBusData);

// Optional: Auto-refresh every 5 minutes
// setInterval(refreshData, 5 * 60 * 1000);

</script>

</body>
</html>
