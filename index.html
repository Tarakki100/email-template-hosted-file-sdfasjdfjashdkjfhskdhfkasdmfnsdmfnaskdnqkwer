<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="robots" content="noindex">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Bus Monitoring - Daily Digest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
.bus-widget .loading{ text-align:center; padding:20px; color:#6a0dad;}
.bus-widget .error{ text-align:center; padding:20px; color:#dc3545; background-color:#f8d7da; border:1px solid #f5c6cb; border-radius:5px;}
.bus-widget .bus-container{ margin-bottom:30px; border:3px solid #6a0dad; border-radius:10px; padding:15px;}
.bus-widget .system-status{ display:flex; justify-content:space-around; flex-wrap:wrap; margin-bottom:15px;}
.bus-widget .status-box{ text-align:center; padding:10px; border:2px solid #6a0dad; border-radius:8px; background-color:#d4edda; color:#155724; margin:5px; flex:1; min-width:120px; max-width:180px;}
.bus-widget table{ width:100%; border-collapse:collapse; margin-bottom:15px;}
.bus-widget th,.bus-widget td{ border:2px solid #6a0dad; padding:12px; text-align:center;}
.bus-widget .more-trips-row{ background-color:#f3e8ff;}

.copy-button {
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #6a0dad;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    z-index: 1000;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.copy-button:hover {
    background-color: #5a0cad;
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.copy-button.copied {
    background-color: #28a745;
}

.copy-button.copied:hover {
    background-color: #28a745;
}
</style>
</head>
<body style="font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 15px;">

<button id="copyButton" class="copy-button">
    <i class="fas fa-copy"></i> Copy Content
</button>

<div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px;">
    <h1 style="text-align: center; color: #6a0dad; margin: 8px 0;">üöå Daily School Bus Report - Priyadarshani International School</h1>
    <p id="report-date" style="text-align: center; font-weight: bold; margin: 6px 0;">Date: Loading...</p>
</div> 
 
<!-- HEADER SECTION WITH LOGO -->
<div class="bus-widget">
<div id="bus-reports-container">
<div class="bus-container">

<!-- Loading/Error Messages -->
<div id="loading" class="loading" style="display:none;">
    <i class="fas fa-spinner fa-spin"></i> Loading bus data...
</div>

<div id="error" class="error" style="display: none;">
    Error loading bus data. Please try again later.
</div>

<!-- Bus Reports Container -->
<div id="bus-reports-container">
<div class="bus-container">

<script>

function getDateFromUrlOrYesterday() {
    const params = new URLSearchParams(window.location.search);
    const dateFromUrl = params.get("date"); // expects ?date=2022-12-05
    
    if (dateFromUrl) {
        return dateFromUrl; // use provided date
    }

    // fallback to yesterday
    const d = new Date();
    d.setDate(d.getDate() - 1);
    return d.toISOString().split("T")[0];
}

function getSchoolFromUrlOrYesterday() {
    const params = new URLSearchParams(window.location.search);
    const dateFromUrl = params.get("school_id"); 
    
    if (dateFromUrl) {
        return dateFromUrl; // use provided date
    }
    return "1";
}
    
// Configuration
const API_CONFIG = {
    baseUrl: 'https://schoolbusapi.com/school/all/bus_summary/',
    schoolId: getSchoolFromUrlOrYesterday(),
    date: getDateFromUrlOrYesterday()
};

// Utility functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
}
function formatSpeed(speedStr) {
    // Example input: "57.00 km/h"
    const num = parseFloat(speedStr); // get number part
    return `${Math.round(num)} km/h`; // round & add unit back
}
function formatTime(timeString) {
    if (!timeString) return '-';
    const date = new Date(timeString);
    return date.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
}

function parseDuration(durationString) {
    if (!durationString) return '-';
    return durationString.replace(/(\d+)h (\d+)m (\d+)s/, '$ h $ m');
}

// Create system status HTML
function createSystemStatus() {
    return `
        <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">üñ• System Status</h3>
        <div class="system-status">
            <div class="status-box">
                <p style="text-align: center; font-weight: bold; margin: 5px 0;">üìπ CCTV</p>
                <strong>OPERATIONAL</strong>
            </div>
            <div class="status-box">
                <p style="text-align: center; font-weight: bold; margin: 5px 0;">üõ∞ GPS</p>
                <strong>OPERATIONAL</strong>
            </div>
            <div class="status-box">
                <p style="text-align: center; font-weight: bold; margin: 5px 0;">üñ• SERVER</p>
                <strong>OPERATIONAL</strong>
            </div>
        </div>
    `;
}

// Create performance summary HTML
function createPerformanceSummary(activitySummary,Trips) {
    let tripRows = '';
let tripNumber = 1;
let totalMinutes = 0;

Trips.forEach(tripObj => {
    const tripKey = Object.keys(tripObj)[0];
    const trip = tripObj[tripKey];

    totalMinutes += parseDuration(trip.duration);

    tripRows += `
        <tr>
            <td>${tripNumber.toString().padStart(2, '0')}</td>
            <td>${formatTime(trip.start_time)}</td>
            <td>${formatTime(trip.end_time)}</td>
            <td>${trip.trip_distance}</td>
            <td>${trip.duration}</td>
            <td>${formatSpeed(trip.max_speed)}</td>
            <td>${trip.average_speed}</td>
        </tr>
    `;
    tripNumber++;
});

console.log("TOTAL MINUTES:", totalMinutes); // üîß Debugging output

const totalDurationFormatted = formatTotalDuration(totalMinutes);

    return `
        <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">üìä Performance & Activity Summary</h3>
        <table>
            <tr>
                <td>üìè Total Distance<br><strong>${activitySummary.total_distance}</strong></td>
                <td>‚è± Running Time<br><strong>${(totalDurationFormatted)}</strong></td>
                <td>üöÄ Max Speed<br><strong>${formatSpeed(activitySummary.max_speed)}</strong></td>
                <td>üéØ Average Speed<br><strong>${activitySummary.average_speed}</strong></td>
            </tr>
        </table>
    `;
}

// Create attendance report HTML
function createAttendanceReport(attendanceData) {
    let tableRows = attendanceData.map(route => `
        <tr>
            <td>${route.route_name}</td>
            <td>${route.total_students}</td>
            <td>${route.present}</td>
            <td>${route.absent}</td>
            <td>${route.not_marked}</td>
        </tr>
    `).join('');

    return `
        <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">üéìRoute Wise Student Attendance Report</h3>
        <table>
            <tr>
                <th>üöç Route Name</th>
                <th>üë©‚Äçüéì Total Students</th>
                <th>‚úÖ Present</th>
                <th>‚ùå Absent</th>
                <th>‚ö† Not Marked</th>
            </tr>
            ${tableRows}
        </table>
    `;
}
function parseDuration(durationStr) {
    console.log("Parsing duration:", durationStr); // üîß Debugging output

    // Accept formats like: "0h 31m", "0 h 31 m", "0 h 31 min"
    let hours = 0, minutes = 0;

    const hourMatch = durationStr.match(/(\d+)\s*h/); // Matches "0h" or "0 h"
    const minuteMatch = durationStr.match(/(\d+)\s*m(in)?/); // Matches "31m" or "31 min"

    if (hourMatch) hours = parseInt(hourMatch[1], 10);
    if (minuteMatch) minutes = parseInt(minuteMatch[1], 10);

    console.log(`‚Üí Parsed: ${hours} hours, ${minutes} minutes`);
    return hours * 60 + minutes;
}

function formatTotalDuration(totalMinutes) {
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    return `${h} h ${m} min`;
}
// Create trip summary HTML
function createTripSummary(tripData) {
let tripRows = '';
let tripNumber = 1;
let totalMinutes = 0;

tripData.forEach(tripObj => {
    const tripKey = Object.keys(tripObj)[0];
    const trip = tripObj[tripKey];

    totalMinutes += parseDuration(trip.duration);

    tripRows += `
        <tr>
            <td>${tripNumber.toString().padStart(2, '0')}</td>
            <td>${formatTime(trip.start_time)}</td>
            <td>${formatTime(trip.end_time)}</td>
            <td>${trip.trip_distance}</td>
            <td>${trip.duration}</td>
            <td>${formatSpeed(trip.max_speed)}</td>
            <td>${trip.average_speed}</td>
        </tr>
    `;
    tripNumber++;
});

console.log("TOTAL MINUTES:", totalMinutes); // üîß Debugging output

const totalDurationFormatted = formatTotalDuration(totalMinutes);

return `
    <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">üöå Trip Summary</h3>
    <table>
        <tr>
            <th>üöç Trip No</th>
            <th>‚è∞ Start Time</th>
            <th>üîö End Time</th>
            <th>‚è≥ Trip Distance</th>
            <th>‚è≤ Duration</th>
            <th>üöÄ Max Speed</th>
            <th>üéØ Avg Speed</th>
        </tr>
        ${tripRows}
    </table>
`;
}

// Create individual bus report HTML
function createBusReport(busName, busData) {
    const busNumber = busName.split(' - ').slice(1).join(' - ');
    const safeBusNumber = busNumber.replace(/\s+/g, "").replace(/[^a-zA-Z0-9\-]/g, "");
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(today.getDate() - 1);
    const yyyy = yesterday.getFullYear();
    const mm = String(yesterday.getMonth() + 1).padStart(2, "0");
    const dd = String(yesterday.getDate()).padStart(2, "0");
    const todayDate = `${yyyy}-${mm}-${dd}`;
    return `
        <div class="bus-container">
            <h2 style="text-align: center; color: #6a0dad; margin: 10px 0;">üöç ${busNumber}</h2>
            ${createSystemStatus()}
            ${createPerformanceSummary(busData.activity_summary,busData.trip_summary)}
            ${createAttendanceReport(busData.route_wise_attendance_report)}
            ${createTripSummary(busData.trip_summary)}
            
            <h3 style="text-align: center; color: #6a0dad; margin: 8px 0;">üöå Speed Analysis</h3>
            <img src="https://postimg/${safeBusNumber}-${todayDate}.png" 
                 alt="Speed Analysis Chart" 
                 style="max-width: 100%; height: auto;">
        </div>
    `;
}

// Copy to clipboard functionality
async function copyRenderedContent() {
    const copyButton = document.getElementById('copyButton');
    const originalText = copyButton.innerHTML;
    
    try {
        // Clone the document and remove scripts
        const html = document.documentElement.cloneNode(true);
        html.querySelectorAll("script").forEach(s => s.remove());
        
        // Remove the copy button from the cloned content
        const copyButtonClone = html.querySelector('#copyButton');
        if (copyButtonClone) {
            copyButtonClone.remove();
        }
        
        // Get the cleaned HTML
        const cleanedHTML = html.outerHTML;
        
        // Copy to clipboard
        await navigator.clipboard.writeText(cleanedHTML);
        
        // Show success feedback
        copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
        copyButton.classList.add('copied');
        
        // Reset after 2 seconds
        setTimeout(() => {
            copyButton.innerHTML = originalText;
            copyButton.classList.remove('copied');
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy: ', err);
        copyButton.innerHTML = '<i class="fas fa-times"></i> Failed';
        setTimeout(() => {
            copyButton.innerHTML = originalText;
        }, 2000);
    }
}

// Fetch and render bus data
async function fetchAndRenderBusData() {
    const loadingElement = document.getElementById('loading');
    const errorElement = document.getElementById('error');
    const containerElement = document.getElementById('bus-reports-container');
    const dateElement = document.getElementById('report-date');

    try {
        // Show loading
        loadingElement.style.display = 'block';
        errorElement.style.display = 'none';

        // Construct API URL
        const apiUrl = `${API_CONFIG.baseUrl}?school_id=${API_CONFIG.schoolId}&date=${API_CONFIG.date}`;
        
        // For demonstration, using the provided sample data
        // In real implementation, uncomment the fetch call below:
        // 
        const response = await fetch(apiUrl);
        // 
        const data = await response.json();
        
        // Sample data for demonstration
        

        // Hide loading
        loadingElement.style.display = 'none';

        // Update date
        dateElement.textContent = `Date: ${formatDate(API_CONFIG.date)}`;

        // Generate HTML for each bus
        let busReportsHtml = '';
        Object.entries(data).forEach(([busName, busData]) => {
            busReportsHtml += createBusReport(busName, busData);
        });

        // Update container
        containerElement.innerHTML = busReportsHtml;

    } catch (error) {
        console.error('Error fetching bus data:', error);
        loadingElement.style.display = 'none';
        errorElement.style.display = 'block';
        errorElement.textContent = `Error loading bus data: ${error.message}`;
    }
}

// Function to refresh data
function refreshData() {
    fetchAndRenderBusData();
}
function formatDuration(durationStr) {
  // Example input: "0 days 00:31:52"
  const regex = /(\d+)\s+days\s+(\d{2}):(\d{2}):(\d{2})/;
  const match = durationStr.match(regex);

  if (!match) return durationStr; // fallback if format is unexpected

  let days = parseInt(match[1], 10);
  let hours = parseInt(match[2], 10);
  let minutes = parseInt(match[3], 10);
  let seconds = parseInt(match[4], 10);

  // Add days to hours if days > 0
  hours += days * 24;

  // Round up minutes if seconds >= 30 (optional)
  if (seconds >= 30) {
    minutes++;
    if (minutes === 60) {
      minutes = 0;
      hours++;
    }
  }

  return `${hours}h ${minutes}m`;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    fetchAndRenderBusData();
    
    // Add event listener for copy button
    document.getElementById('copyButton').addEventListener('click', copyRenderedContent);
});

// Optional: Auto-refresh every 5 minutes
// setInterval(refreshData, 5 * 60 * 1000);

</script>

</body>
</html>
